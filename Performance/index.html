


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Personal fork of Go Programming Language Wiki">
      
      
        <link rel="canonical" href="https://zchee.github.io/golang-wiki/Performance/">
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.1">
    
    
      
        <title>Performance - Go Programming Language Wiki</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a676eddb.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.b302131d.min.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-89201129-1","https://zchee.github.io/golang-wiki/"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="blue">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#debugging-performance-issues-in-go-programs" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://zchee.github.io/golang-wiki/" title="Go Programming Language Wiki" class="md-header-nav__button md-logo" aria-label="Go Programming Language Wiki">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Go Programming Language Wiki
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Performance
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/zchee/golang-wiki/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zchee/golang-wiki
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://zchee.github.io/golang-wiki/" title="Go Programming Language Wiki" class="md-nav__button md-logo" aria-label="Go Programming Language Wiki">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    Go Programming Language Wiki
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/zchee/golang-wiki/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    zchee/golang-wiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../Home/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      WhyGo
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="WhyGo" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        WhyGo
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../WhyGo/" title="WhyGo" class="md-nav__link">
      WhyGo
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Install
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Install" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Install
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Windows/" title="Windows" class="md-nav__link">
      Windows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Ubuntu/" title="Ubuntu" class="md-nav__link">
      Ubuntu
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../InstallFromSource/" title="Source" class="md-nav__link">
      Source
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Articles/" title="Articles" class="md-nav__link">
      Articles
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../AssemblyPolicy/" title="AssemblyPolicy" class="md-nav__link">
      AssemblyPolicy
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../AVX512/" title="AVX512" class="md-nav__link">
      AVX512
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Benchmarks/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Blogs/" title="Blogs" class="md-nav__link">
      Blogs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Books/" title="Books" class="md-nav__link">
      Books
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../BoundingResourceUse/" title="BoundingResourceUse" class="md-nav__link">
      BoundingResourceUse
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../cgo/" title="cgo" class="md-nav__link">
      cgo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ChromeOS/" title="ChromeOS" class="md-nav__link">
      ChromeOS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CodeReview/" title="CodeReview" class="md-nav__link">
      CodeReview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CodeReviewComments/" title="CodeReviewComments" class="md-nav__link">
      CodeReviewComments
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CodeTools/" title="CodeTools" class="md-nav__link">
      CodeTools
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Comments/" title="Comments" class="md-nav__link">
      Comments
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CommitMessage/" title="CommitMessage" class="md-nav__link">
      CommitMessage
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CommonMistakes/" title="CommonMistakes" class="md-nav__link">
      CommonMistakes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CompilerOptimizations/" title="CompilerOptimizations" class="md-nav__link">
      CompilerOptimizations
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Conferences/" title="Conferences" class="md-nav__link">
      Conferences
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Configuring-GoLand-for-WebAssembly/" title="Configuring-GoLand-for-WebAssembly" class="md-nav__link">
      Configuring-GoLand-for-WebAssembly
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Contributing-to-gopls/" title="Contributing-to-gopls" class="md-nav__link">
      Contributing-to-gopls
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CoreDumpDebugging/" title="CoreDumpDebugging" class="md-nav__link">
      CoreDumpDebugging
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Courses/" title="Courses" class="md-nav__link">
      Courses
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CreatingSubRepository/" title="CreatingSubRepository" class="md-nav__link">
      CreatingSubRepository
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CSSStyleGuide/" title="CSSStyleGuide" class="md-nav__link">
      CSSStyleGuide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CustomPprofProfiles/" title="CustomPprofProfiles" class="md-nav__link">
      CustomPprofProfiles
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Darwin/" title="Darwin" class="md-nav__link">
      Darwin
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../DashboardBuilders/" title="DashboardBuilders" class="md-nav__link">
      DashboardBuilders
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Deprecated/" title="Deprecated" class="md-nav__link">
      Deprecated
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../DesignDocuments/" title="DesignDocuments" class="md-nav__link">
      DesignDocuments
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../DevExp/" title="DevExp" class="md-nav__link">
      DevExp
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Diagnostics/" title="Diagnostics" class="md-nav__link">
      Diagnostics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../DragonFly-BSD/" title="DragonFly-BSD" class="md-nav__link">
      DragonFly-BSD
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Errors/" title="Errors" class="md-nav__link">
      Errors
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ErrorValueFAQ/" title="ErrorValueFAQ" class="md-nav__link">
      ErrorValueFAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ExperienceReports/" title="ExperienceReports" class="md-nav__link">
      ExperienceReports
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../FileTreeDocumentation/" title="FileTreeDocumentation" class="md-nav__link">
      FileTreeDocumentation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../FreeBSD/" title="FreeBSD" class="md-nav__link">
      FreeBSD
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../FromXToGo/" title="FromXToGo" class="md-nav__link">
      FromXToGo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Frozen/" title="Frozen" class="md-nav__link">
      Frozen
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Gardening/" title="Gardening" class="md-nav__link">
      Gardening
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GccgoCrossCompilation/" title="GccgoCrossCompilation" class="md-nav__link">
      GccgoCrossCompilation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GcToolchainTricks/" title="GcToolchainTricks" class="md-nav__link">
      GcToolchainTricks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GerritAccess/" title="GerritAccess" class="md-nav__link">
      GerritAccess
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GerritBot/" title="GerritBot" class="md-nav__link">
      GerritBot
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GithubAccess/" title="GithubAccess" class="md-nav__link">
      GithubAccess
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GitHubCodeLayout/" title="GitHubCodeLayout" class="md-nav__link">
      GitHubCodeLayout
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go-1.10-Release-Party/" title="Go-1.10-Release-Party" class="md-nav__link">
      Go-1.10-Release-Party
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go-1.6-release-party/" title="Go-1.6-release-party" class="md-nav__link">
      Go-1.6-release-party
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go-1.8-Release-Party/" title="Go-1.8-Release-Party" class="md-nav__link">
      Go-1.8-Release-Party
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go-Community-Slides/" title="Go-Community-Slides" class="md-nav__link">
      Go-Community-Slides
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go-Release-Cycle/" title="Go-Release-Cycle" class="md-nav__link">
      Go-Release-Cycle
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go1point1Gotchas/" title="Go1point1Gotchas" class="md-nav__link">
      Go1point1Gotchas
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go2/" title="Go2" class="md-nav__link">
      Go2
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go2ErrorHandlingFeedback/" title="Go2ErrorHandlingFeedback" class="md-nav__link">
      Go2ErrorHandlingFeedback
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go2ErrorValuesFeedback/" title="Go2ErrorValuesFeedback" class="md-nav__link">
      Go2ErrorValuesFeedback
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Go2GenericsFeedback/" title="Go2GenericsFeedback" class="md-nav__link">
      Go2GenericsFeedback
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoArm/" title="GoArm" class="md-nav__link">
      GoArm
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoForCPPProgrammers/" title="GoForCPPProgrammers" class="md-nav__link">
      GoForCPPProgrammers
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoGenerateTools/" title="GoGenerateTools" class="md-nav__link">
      GoGenerateTools
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoGetProxyConfig/" title="GoGetProxyConfig" class="md-nav__link">
      GoGetProxyConfig
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoGetTools/" title="GoGetTools" class="md-nav__link">
      GoGetTools
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../golang-tools/" title="golang-tools" class="md-nav__link">
      golang-tools
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoMips/" title="GoMips" class="md-nav__link">
      GoMips
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Gomote/" title="Gomote" class="md-nav__link">
      Gomote
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GOPATH/" title="GOPATH" class="md-nav__link">
      GOPATH
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Gopher/" title="Gopher" class="md-nav__link">
      Gopher
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../gopherbot/" title="gopherbot" class="md-nav__link">
      gopherbot
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../gopls-integrator-FAQ/" title="gopls-integrator-FAQ" class="md-nav__link">
      gopls-integrator-FAQ
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../gopls/" title="gopls" class="md-nav__link">
      gopls
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoStrings/" title="GoStrings" class="md-nav__link">
      GoStrings
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoTalks/" title="GoTalks" class="md-nav__link">
      GoTalks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoUserGroups/" title="GoUserGroups" class="md-nav__link">
      GoUserGroups
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoUsers/" title="GoUsers" class="md-nav__link">
      GoUsers
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../GoVsGenerics/" title="GoVsGenerics" class="md-nav__link">
      GoVsGenerics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../HandlingIssues/" title="HandlingIssues" class="md-nav__link">
      HandlingIssues
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Hashing/" title="Hashing" class="md-nav__link">
      Hashing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../heapdump13/" title="heapdump13" class="md-nav__link">
      heapdump13
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../heapdump14/" title="heapdump14" class="md-nav__link">
      heapdump14
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../heapdump15-through-heapdump17/" title="heapdump15-through-heapdump17" class="md-nav__link">
      heapdump15-through-heapdump17
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../heapdump15/" title="heapdump15" class="md-nav__link">
      heapdump15
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../HostedContinuousIntegration/" title="HostedContinuousIntegration" class="md-nav__link">
      HostedContinuousIntegration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../How-to-ask-for-help/" title="How-to-ask-for-help" class="md-nav__link">
      How-to-ask-for-help
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../HowToAsk/" title="HowToAsk" class="md-nav__link">
      HowToAsk
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../HttpFetch/" title="HttpFetch" class="md-nav__link">
      HttpFetch
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../HttpStaticFiles/" title="HttpStaticFiles" class="md-nav__link">
      HttpStaticFiles
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../IDEsAndTextEditorPlugins/" title="IDEsAndTextEditorPlugins" class="md-nav__link">
      IDEsAndTextEditorPlugins
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../InstallFromSource/" title="InstallFromSource" class="md-nav__link">
      InstallFromSource
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../InstallTroubleshooting/" title="InstallTroubleshooting" class="md-nav__link">
      InstallTroubleshooting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../InterfaceSlice/" title="InterfaceSlice" class="md-nav__link">
      InterfaceSlice
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../InvalidFlag/" title="InvalidFlag" class="md-nav__link">
      InvalidFlag
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Iota/" title="Iota" class="md-nav__link">
      Iota
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../IssueLabels/" title="IssueLabels" class="md-nav__link">
      IssueLabels
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Learn/" title="Learn" class="md-nav__link">
      Learn
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../LearnConcurrency/" title="LearnConcurrency" class="md-nav__link">
      LearnConcurrency
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../LearnErrorHandling/" title="LearnErrorHandling" class="md-nav__link">
      LearnErrorHandling
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../LearnServerProgramming/" title="LearnServerProgramming" class="md-nav__link">
      LearnServerProgramming
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../LearnTesting/" title="LearnTesting" class="md-nav__link">
      LearnTesting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Linux/" title="Linux" class="md-nav__link">
      Linux
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../LinuxKernelSignalVectorBug/" title="LinuxKernelSignalVectorBug" class="md-nav__link">
      LinuxKernelSignalVectorBug
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../LockOSThread/" title="LockOSThread" class="md-nav__link">
      LockOSThread
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../MethodSets/" title="MethodSets" class="md-nav__link">
      MethodSets
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../MinimumRequirements/" title="MinimumRequirements" class="md-nav__link">
      MinimumRequirements
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../MinorReleases/" title="MinorReleases" class="md-nav__link">
      MinorReleases
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Mobile/" title="Mobile" class="md-nav__link">
      Mobile
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Modules/" title="Modules" class="md-nav__link">
      Modules
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../MultipleGoRoots/" title="MultipleGoRoots" class="md-nav__link">
      MultipleGoRoots
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../MutexOrChannel/" title="MutexOrChannel" class="md-nav__link">
      MutexOrChannel
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../NativeClient/" title="NativeClient" class="md-nav__link">
      NativeClient
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../NetBSD/" title="NetBSD" class="md-nav__link">
      NetBSD
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../NewSpeakers/" title="NewSpeakers" class="md-nav__link">
      NewSpeakers
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../NoMeToo/" title="NoMeToo" class="md-nav__link">
      NoMeToo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../NonEnglish/" title="NonEnglish" class="md-nav__link">
      NonEnglish
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../NoPlusOne/" title="NoPlusOne" class="md-nav__link">
      NoPlusOne
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../OlderVersions/" title="OlderVersions" class="md-nav__link">
      OlderVersions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../OpenBSD/" title="OpenBSD" class="md-nav__link">
      OpenBSD
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PackageManagementTools/" title="PackageManagementTools" class="md-nav__link">
      PackageManagementTools
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PackagePublishing/" title="PackagePublishing" class="md-nav__link">
      PackagePublishing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PanicAndRecover/" title="PanicAndRecover" class="md-nav__link">
      PanicAndRecover
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PerfDashboard/" title="PerfDashboard" class="md-nav__link">
      PerfDashboard
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Performance
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Performance" class="md-nav__link md-nav__link--active">
      Performance
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cpu-profiler" class="md-nav__link">
    CPU Profiler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-profiler" class="md-nav__link">
    Memory Profiler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#blocking-profiler" class="md-nav__link">
    Blocking Profiler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#goroutine-profiler" class="md-nav__link">
    Goroutine Profiler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#garbage-collector-trace" class="md-nav__link">
    Garbage Collector Trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-allocator-trace" class="md-nav__link">
    Memory Allocator Trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduler-trace" class="md-nav__link">
    Scheduler Trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-statistics" class="md-nav__link">
    Memory Statistics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#heap-dumper" class="md-nav__link">
    Heap Dumper
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concluding-remarks" class="md-nav__link">
    Concluding Remarks
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Plan9/" title="Plan9" class="md-nav__link">
      Plan9
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Podcasts/" title="Podcasts" class="md-nav__link">
      Podcasts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PortingPolicy/" title="PortingPolicy" class="md-nav__link">
      PortingPolicy
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../PriorDiscussion/" title="PriorDiscussion" class="md-nav__link">
      PriorDiscussion
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Projects/" title="Projects" class="md-nav__link">
      Projects
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Proposals/" title="Proposals" class="md-nav__link">
      Proposals
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ProviderIntegration/" title="ProviderIntegration" class="md-nav__link">
      ProviderIntegration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Questions/" title="Questions" class="md-nav__link">
      Questions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../RaceDetector/" title="RaceDetector" class="md-nav__link">
      RaceDetector
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Range/" title="Range" class="md-nav__link">
      Range
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../RateLimiting/" title="RateLimiting" class="md-nav__link">
      RateLimiting
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Rationales/" title="Rationales" class="md-nav__link">
      Rationales
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ResearchPapers/" title="ResearchPapers" class="md-nav__link">
      ResearchPapers
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Resolving-Problems-From-Modified-Module-Path/" title="Resolving-Problems-From-Modified-Module-Path" class="md-nav__link">
      Resolving-Problems-From-Modified-Module-Path
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Screencasts/" title="Screencasts" class="md-nav__link">
      Screencasts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SendingMail/" title="SendingMail" class="md-nav__link">
      SendingMail
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SettingGOPATH/" title="SettingGOPATH" class="md-nav__link">
      SettingGOPATH
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SignalHandling/" title="SignalHandling" class="md-nav__link">
      SignalHandling
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SimultaneousAssignment/" title="SimultaneousAssignment" class="md-nav__link">
      SimultaneousAssignment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SliceTricks/" title="SliceTricks" class="md-nav__link">
      SliceTricks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SlowBots/" title="SlowBots" class="md-nav__link">
      SlowBots
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Solaris/" title="Solaris" class="md-nav__link">
      Solaris
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Spelling/" title="Spelling" class="md-nav__link">
      Spelling
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SQLDrivers/" title="SQLDrivers" class="md-nav__link">
      SQLDrivers
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SQLInterface/" title="SQLInterface" class="md-nav__link">
      SQLInterface
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Style/" title="Style" class="md-nav__link">
      Style
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SubRepositories/" title="SubRepositories" class="md-nav__link">
      SubRepositories
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../SuccessStories/" title="SuccessStories" class="md-nav__link">
      SuccessStories
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Switch/" title="Switch" class="md-nav__link">
      Switch
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../TableDrivenTests/" title="TableDrivenTests" class="md-nav__link">
      TableDrivenTests
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../TargetSpecific/" title="TargetSpecific" class="md-nav__link">
      TargetSpecific
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../TestComments/" title="TestComments" class="md-nav__link">
      TestComments
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Timeouts/" title="Timeouts" class="md-nav__link">
      Timeouts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Training/" title="Training" class="md-nav__link">
      Training
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../vgo/" title="vgo" class="md-nav__link">
      vgo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../WebAccessibilityResourcesAndTips/" title="WebAccessibilityResourcesAndTips" class="md-nav__link">
      WebAccessibilityResourcesAndTips
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Well-known-struct-tags/" title="Well-known-struct-tags" class="md-nav__link">
      Well-known-struct-tags
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../windows-scoop-install-go-cli/" title="windows-scoop-install-go-cli" class="md-nav__link">
      windows-scoop-install-go-cli
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../WindowsBuild/" title="WindowsBuild" class="md-nav__link">
      WindowsBuild
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../WindowsCrossCompiling/" title="WindowsCrossCompiling" class="md-nav__link">
      WindowsCrossCompiling
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../WindowsDLLs/" title="WindowsDLLs" class="md-nav__link">
      WindowsDLLs
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cpu-profiler" class="md-nav__link">
    CPU Profiler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-profiler" class="md-nav__link">
    Memory Profiler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#blocking-profiler" class="md-nav__link">
    Blocking Profiler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#goroutine-profiler" class="md-nav__link">
    Goroutine Profiler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#garbage-collector-trace" class="md-nav__link">
    Garbage Collector Trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-allocator-trace" class="md-nav__link">
    Memory Allocator Trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduler-trace" class="md-nav__link">
    Scheduler Trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-statistics" class="md-nav__link">
    Memory Statistics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#heap-dumper" class="md-nav__link">
    Heap Dumper
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concluding-remarks" class="md-nav__link">
    Concluding Remarks
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/zchee/golang-wiki/edit/master/docs/Performance.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="debugging-performance-issues-in-go-programs">Debugging performance issues in Go programs</h1>
<p>-- originally written by Dmitry Vyukov</p>
<p>Let's assume you have a Go program and want to improve its performance. There
are several tools available that can help with this task. These tools can help
you to identify various types of hotspots (CPU, IO, memory), hotspots are the
places that you need to concentrate on in order to significantly improve
performance. However, another outcome is possible -- the tools can help you
identify obvious performance defects in the program. For example, you prepare an
SQL statement before each query while you could prepare it once at program
startup. Another example is if an O(N^2) algorithm somehow slipped into where an
obvious O(N) exists and is expected. In order to identify such cases you need to
sanity check what you see in profiles. For example for the first case
significant time spent in SQL statement preparation would be the red flag.</p>
<p>It's also important to understand various bounding factors for performance. For
example, if the program communicates via 100 Mbps network link and it is already
utilizes &gt;90Mbps, there is not much you can do with the program to improve its
performance. There are similar bounding factors for disk IO, memory consumption
and computational tasks. With that in mind we can look at the available tools.</p>
<p>Note: The tools can interfere with each other. For example, precise memory
profiling skews CPU profiles, goroutine blocking profiling affects scheduler
trace, etc. Use tools in isolation to get more precise info.</p>
<h2 id="cpu-profiler">CPU Profiler</h2>
<p>Go runtime contains built-in CPU profiler, which shows what functions consume
what percent of CPU time. There are 3 ways you can get access to it:</p>
<ol>
<li>
<p>The simplest one is -cpuprofile flag of 'go test'
    (<a href="http://golang.org/cmd/go/#hdr-Description_of_testing_flags">http://golang.org/cmd/go/#hdr-Description_of_testing_flags</a>) command. For
    example, the following command:</p>
<div class="codehilite"><pre><span></span><code>$ go <span class="nb">test</span> -run<span class="o">=</span>none -bench<span class="o">=</span>ClientServerParallel4 -cpuprofile<span class="o">=</span>cprof net/http
</code></pre></div>


<p>will profile the given benchmark and write CPU profile into 'cprof' file.
Then:</p>
<div class="codehilite"><pre><span></span><code>$ go tool pprof --text http.test cprof
</code></pre></div>


<p>will print a list of the hottest functions.</p>
<p>There are several output types available, the most useful ones are:
<code>--text</code>, <code>--web</code> and <code>--list</code>. Run <code>go tool pprof</code> to get the complete
list. The obvious drawback of this option is that it works only for tests.</p>
</li>
<li>
<p><a href="http://golang.org/pkg/net/http/pprof">net/http/pprof</a>: This is the ideal
    solution for network servers. You merely need to import <code>net/http/pprof</code>,
    and collect profiles with:</p>
<div class="codehilite"><pre><span></span><code>$ go tool pprof --text mybin  http://myserver:6060:/debug/pprof/profile
</code></pre></div>


</li>
<li>
<p>Manual profile collection. You need to import
    <a href="http://golang.org/pkg/runtime/pprof/">runtime/pprof</a> and add the following
    code to main function:</p>
<div class="codehilite"><pre><span></span><code><span class="err">if *flagCpuprofile != &quot;&quot; {</span>
<span class="err">    f, err := os.Create(*flagCpuprofile)</span>
<span class="err">    if err != nil {</span>
<span class="err">        log.Fatal(err)</span>
<span class="err">    }</span>
<span class="err">    pprof.StartCPUProfile(f)</span>
<span class="err">    defer pprof.StopCPUProfile()</span>
<span class="err">}</span>
</code></pre></div>


<p>The profile will be written to the specified file, visualize it the same way
as in the first option.</p>
</li>
</ol>
<p>Here is an example of a profile visualized with <code>--web</code> option:
[cpu_profile.png]</p>
<p>You can investigate a single function with <code>--list=funcname</code> option. For
example, the following profile shows that the time was spent in the <code>append</code>
function:</p>
<div class="codehilite"><pre><span></span><code><span class="err"> .      .   93: func (bp *buffer) WriteRune(r rune) error {</span>
<span class="err"> .      .   94:     if r &lt; utf8.RuneSelf {</span>
<span class="err"> 5      5   95:         *bp = append(*bp, byte(r))</span>
<span class="err"> .      .   96:         return nil</span>
<span class="err"> .      .   97:     }</span>
<span class="err"> .      .   98:</span>
<span class="err"> .      .   99:     b := *bp</span>
<span class="err"> .      .  100:     n := len(b)</span>
<span class="err"> .      .  101:     for n+utf8.UTFMax &gt; cap(b) {</span>
<span class="err"> .      .  102:         b = append(b, 0)</span>
<span class="err"> .      .  103:     }</span>
<span class="err"> .      .  104:     w := utf8.EncodeRune(b[n:n+utf8.UTFMax], r)</span>
<span class="err"> .      .  105:     *bp = b[:n+w]</span>
<span class="err"> .      .  106:     return nil</span>
<span class="err"> .      .  107: }</span>
</code></pre></div>


<p>There are also 3 special entries that the profiler uses when it can't unwind
stack: GC, System and ExternalCode. GC means time spent during garbage
collection, see Memory Profiler and Garbage Collector Trace sections below for
optimization suggestions. System means time spent in goroutine scheduler, stack
management code and other auxiliary runtime code. ExternalCode means time spent
in native dynamic libraries.</p>
<p>Here are some hints with respect to how to interpret what you see in the
profile.</p>
<p>If you see lots of time spent in <code>runtime.mallocgc</code> function, the program
potentially makes excessive amount of small memory allocations. The profile will
tell you where the allocations are coming from. See the memory profiler section
for suggestions on how to optimize this case.</p>
<p>If lots of time is spent in channel operations, sync.Mutex code and other
synchronization primitives or System component, the program probably suffers
from contention. Consider to restructure program to eliminate frequently
accessed shared resources. Common techniques for this include
sharding/partitioning, local buffering/batching and copy-on-write technique.</p>
<p>If lots of time is spent in <code>syscall.Read/Write</code>, the program potentially makes
excessive amount of small reads and writes. Bufio wrappers around os.File or
net.Conn can help in this case.</p>
<p>If lots of time is spent in GC component, the program either allocates too many
transient objects or heap size is very small so garbage collections happen too
frequently. See Garbage Collector Tracer and Memory Profiler sections for
optimization suggestions.</p>
<p>Note: For darwin CPU profiler currently only <a href="https://code.google.com/p/go/issues/detail?id=6047">works on El Capitan or newer</a>.</p>
<p>Note: On windows you need to install Cygwin, Perl and Graphviz to generate
svg/web profiles.</p>
<h2 id="memory-profiler">Memory Profiler</h2>
<p>Memory profiler shows what functions allocate heap memory. You can collect it in
similar ways as CPU profile: with <code>go test --memprofile</code>
(<a href="http://golang.org/cmd/go/#hdr-Description_of_testing_flags">http://golang.org/cmd/go/#hdr-Description_of_testing_flags</a>), with
<a href="http://golang.org/pkg/net/http/pprof">net/http/pprof</a> via
<a href="http://myserver:6060:/debug/pprof/heap">http://myserver:6060:/debug/pprof/heap</a> or by calling
<a href="http://golang.org/pkg/runtime/pprof/#WriteHeapProfile">runtime/pprof.WriteHeapProfile</a>.</p>
<p>You can visualize only allocations live at the time of profile collection
(<code>--inuse_space flag to pprof</code>, default), or all allocations happened since
program start (<code>--alloc_space</code> flag to <code>pprof</code>). The former is useful for
profiles collected with net/http/pprof on live applications, the latter is
useful for profiles collected at program end (otherwise you will see almost
empty profile).</p>
<p>Note: the memory profiler is sampling, that is, it collects information only
about some subset of memory allocations. Probability of sampling an object is
proportional to its size. You can change the sampling rate with go test
<code>--memprofilerate</code> flag, or by setting <code>runtime.MemProfileRate</code> variable at
program startup. The rate of 1 will lead to collection of information about all
allocations, but it can slow down execution. The default sampling rate is 1
sample per 512KB of allocated memory.</p>
<p>You can also visualize number of bytes allocated or number of objects allocated
(<code>--inuse/alloc_space</code> and <code>--inuse/alloc_objects</code> flags, respectively). The
profiler tends to sample larger objects during profiling more. But it's
important to understand that large objects affect memory consumption and GC
time, while large number of tiny allocations affects execution speed (and GC
time to some degree as well). So it may be useful to look at both.</p>
<p>Objects can be persistent or transient. If you have several large persistent
objects allocated at program start, they will be most likely sampled by the
profiler (because they are large). Such objects do affect memory consumption and
GC time, but they do not affect normal execution speed (no memory management
operations happen on them). On the other hand if you have large number of
objects with very short life durations, they can be barely represented in the
profile (if you use the default <code>--inuse_space mode</code>). But they do significantly
affect execution speed, because they are constantly allocated and freed. So,
once again, it may be useful to look at both types of objects. So, generally, if
you want to reduce memory consumption, you need to look at <code>--inuse_space</code>
profile collected during normal program operation. If you want to improve
execution speed, look at <code>--alloc_objects</code> profile collected after significant
running time or at program end.</p>
<p>There are several flags that control reporting granularity. <code>--functions</code> makes
pprof report on function level (default). <code>--lines</code> makes pprof report on source
line level, which is useful if hot functions allocate on different lines. And
there are also <code>--addresses</code> and <code>--files</code> for exact instruction address and
file level, respectively.</p>
<p>There is a useful option for the memory profile -- you can look at it right in
the browser (provided that you imported <code>net/http/pprof</code>). If you open
<a href="http://myserver:6060/debug/pprof/heap?debug=1">http://myserver:6060/debug/pprof/heap?debug=1</a> you must see the heap profile
along the lines of:</p>
<div class="codehilite"><pre><span></span><code><span class="n">heap</span><span class="w"> </span><span class="nl">profile</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="err">:</span><span class="w"> </span><span class="mi">266528</span><span class="w"> </span><span class="o">[</span><span class="n">123: 11284472</span><span class="o">]</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="n">heap</span><span class="o">/</span><span class="mi">1048576</span><span class="w"></span>
<span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="mi">262144</span><span class="w"> </span><span class="o">[</span><span class="n">4: 376832</span><span class="o">]</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x28d9f</span><span class="w"> </span><span class="mh">0x2a201</span><span class="w"> </span><span class="mh">0x2a28a</span><span class="w"> </span><span class="mh">0x2624d</span><span class="w"> </span><span class="mh">0x26188</span><span class="w"> </span><span class="mh">0x94ca3</span><span class="w"> </span><span class="mh">0x94a0b</span><span class="w"> </span><span class="mh">0x17add6</span><span class="w"> </span><span class="mh">0x17ae9f</span><span class="w"> </span><span class="mh">0x1069d3</span><span class="w"> </span><span class="mh">0xfe911</span><span class="w"> </span><span class="mh">0xf0a3e</span><span class="w"> </span><span class="mh">0xf0d22</span><span class="w"> </span><span class="mh">0x21a70</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x2a201</span><span class="w"> </span><span class="n">cnew</span><span class="o">+</span><span class="mh">0xc1</span><span class="w">   </span><span class="n">runtime</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="nl">goc</span><span class="p">:</span><span class="mi">718</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x2a28a</span><span class="w"> </span><span class="n">runtime</span><span class="p">.</span><span class="n">cnewarray</span><span class="o">+</span><span class="mh">0x3a</span><span class="w">          </span><span class="n">runtime</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="nl">goc</span><span class="p">:</span><span class="mi">731</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x2624d</span><span class="w"> </span><span class="n">makeslice1</span><span class="o">+</span><span class="mh">0x4d</span><span class="w">             </span><span class="n">runtime</span><span class="o">/</span><span class="n">slice</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">57</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x26188</span><span class="w"> </span><span class="n">runtime</span><span class="p">.</span><span class="n">makeslice</span><span class="o">+</span><span class="mh">0x98</span><span class="w">          </span><span class="n">runtime</span><span class="o">/</span><span class="n">slice</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">38</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x94ca3</span><span class="w"> </span><span class="n">bytes</span><span class="p">.</span><span class="n">makeSlice</span><span class="o">+</span><span class="mh">0x63</span><span class="w">            </span><span class="n">bytes</span><span class="o">/</span><span class="n">buffer</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">191</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x94a0b</span><span class="w"> </span><span class="n">bytes</span><span class="p">.(</span><span class="o">*</span><span class="n">Buffer</span><span class="p">).</span><span class="n">ReadFrom</span><span class="o">+</span><span class="mh">0xcb</span><span class="w">       </span><span class="n">bytes</span><span class="o">/</span><span class="n">buffer</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">163</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x17add6</span><span class="w">    </span><span class="n">io</span><span class="o">/</span><span class="n">ioutil</span><span class="p">.</span><span class="n">readAll</span><span class="o">+</span><span class="mh">0x156</span><span class="w">         </span><span class="n">io</span><span class="o">/</span><span class="n">ioutil</span><span class="o">/</span><span class="n">ioutil</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">32</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x17ae9f</span><span class="w">    </span><span class="n">io</span><span class="o">/</span><span class="n">ioutil</span><span class="p">.</span><span class="n">ReadAll</span><span class="o">+</span><span class="mh">0x3f</span><span class="w">          </span><span class="n">io</span><span class="o">/</span><span class="n">ioutil</span><span class="o">/</span><span class="n">ioutil</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">41</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x1069d3</span><span class="w">    </span><span class="n">godoc</span><span class="o">/</span><span class="n">vfs</span><span class="p">.</span><span class="n">ReadFile</span><span class="o">+</span><span class="mh">0x133</span><span class="w">            </span><span class="n">godoc</span><span class="o">/</span><span class="n">vfs</span><span class="o">/</span><span class="n">vfs</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">44</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0xfe911</span><span class="w"> </span><span class="n">godoc</span><span class="p">.</span><span class="n">func</span><span class="err"></span><span class="mi">023</span><span class="o">+</span><span class="mh">0x471</span><span class="w">            </span><span class="n">godoc</span><span class="o">/</span><span class="n">meta</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">80</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0xf0a3e</span><span class="w"> </span><span class="n">godoc</span><span class="p">.(</span><span class="o">*</span><span class="n">Corpus</span><span class="p">).</span><span class="n">updateMetadata</span><span class="o">+</span><span class="mh">0x9e</span><span class="w">     </span><span class="n">godoc</span><span class="o">/</span><span class="n">meta</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">101</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0xf0d22</span><span class="w"> </span><span class="n">godoc</span><span class="p">.(</span><span class="o">*</span><span class="n">Corpus</span><span class="p">).</span><span class="n">refreshMetadataLoop</span><span class="o">+</span><span class="mh">0x42</span><span class="w">    </span><span class="n">godoc</span><span class="o">/</span><span class="n">meta</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">141</span><span class="w"></span>

<span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="o">[</span><span class="n">2: 4096</span><span class="o">]</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="mh">0x28d9f</span><span class="w"> </span><span class="mh">0x29059</span><span class="w"> </span><span class="mh">0x1d252</span><span class="w"> </span><span class="mh">0x1d450</span><span class="w"> </span><span class="mh">0x106993</span><span class="w"> </span><span class="mh">0xf1225</span><span class="w"> </span><span class="mh">0xe1489</span><span class="w"> </span><span class="mh">0xfbcad</span><span class="w"> </span><span class="mh">0x21a70</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x1d252</span><span class="w"> </span><span class="n">newdefer</span><span class="o">+</span><span class="mh">0x112</span><span class="w">              </span><span class="n">runtime</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">49</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x1d450</span><span class="w"> </span><span class="n">runtime</span><span class="p">.</span><span class="n">deferproc</span><span class="o">+</span><span class="mh">0x10</span><span class="w">          </span><span class="n">runtime</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">132</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0x106993</span><span class="w">    </span><span class="n">godoc</span><span class="o">/</span><span class="n">vfs</span><span class="p">.</span><span class="n">ReadFile</span><span class="o">+</span><span class="mh">0xf3</span><span class="w">         </span><span class="n">godoc</span><span class="o">/</span><span class="n">vfs</span><span class="o">/</span><span class="n">vfs</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">43</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0xf1225</span><span class="w"> </span><span class="n">godoc</span><span class="p">.(</span><span class="o">*</span><span class="n">Corpus</span><span class="p">).</span><span class="n">parseFile</span><span class="o">+</span><span class="mh">0x75</span><span class="w">      </span><span class="n">godoc</span><span class="o">/</span><span class="n">parser</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">20</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0xe1489</span><span class="w"> </span><span class="n">godoc</span><span class="p">.(</span><span class="o">*</span><span class="n">treeBuilder</span><span class="p">).</span><span class="n">newDirTree</span><span class="o">+</span><span class="mh">0x8e9</span><span class="w">   </span><span class="n">godoc</span><span class="o">/</span><span class="n">dirtrees</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">108</span><span class="w"></span>
<span class="err">#</span><span class="w">   </span><span class="mh">0xfbcad</span><span class="w"> </span><span class="n">godoc</span><span class="p">.</span><span class="n">func</span><span class="err"></span><span class="mi">002</span><span class="o">+</span><span class="mh">0x15d</span><span class="w">            </span><span class="n">godoc</span><span class="o">/</span><span class="n">dirtrees</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">100</span><span class="w"></span>
</code></pre></div>


<p>The numbers in the beginning of each entry <code>("1: 262144 [4: 376832]")</code> represent
number of currently live objects, amount of memory occupied by live objects,
total number of allocations and amount of memory occupied by all allocations,
respectively.</p>
<p>Optimizations are usually application-specific, but here are some common
suggestions.</p>
<ol>
<li>
<p>Combine objects into larger objects. For example, replace <code>*bytes.Buffer</code>
    struct member with <code>bytes.Buffer</code> (you can preallocate buffer for writing by
    calling <code>bytes.Buffer.Grow</code> later). This will reduce number of memory
    allocations (faster) and also reduce pressure on garbage collector (faster
    garbage collections).</p>
</li>
<li>
<p>Local variables that escape from their declaration scope get promoted into
    heap allocations. Compiler generally can't prove that several variables have
    the same life time, so it allocates each such variable separately. So you
    can use the above advise for local variables as well. For example, replace:</p>
<div class="codehilite"><pre><span></span><code><span class="err">for k, v := range m {</span>
<span class="err">    k, v := k, v   // copy for capturing by the goroutine</span>
<span class="err">    go func() {</span>
<span class="err">        // use k and v</span>
<span class="err">    }()</span>
<span class="err">}</span>
</code></pre></div>


<p>with:</p>
<div class="codehilite"><pre><span></span><code><span class="err">for k, v := range m {</span>
<span class="err">    x := struct{ k, v string }{k, v}   // copy for capturing by the goroutine</span>
<span class="err">    go func() {</span>
<span class="err">        // use x.k and x.v</span>
<span class="err">    }()</span>
<span class="err">}</span>
</code></pre></div>


<p>This replaces two memory allocations with a single allocation. However, this
optimization usually negatively affects code readability, so use it
reasonably.</p>
</li>
<li>
<p>A special case of allocation combining is slice array preallocation. If you
    know a typical size of the slice, you can preallocate a backing array for it
    as follows:</p>
<div class="codehilite"><pre><span></span><code><span class="k">type</span> <span class="n">X</span> <span class="n">struct</span> <span class="err">{</span>
    <span class="n">buf</span>      <span class="p">[]</span><span class="n">byte</span>
    <span class="n">bufArray</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="n">byte</span> <span class="o">//</span> <span class="n">Buf</span> <span class="n">usually</span> <span class="n">does</span> <span class="k">not</span> <span class="n">grow</span> <span class="n">beyond</span> <span class="mi">16</span> <span class="n">bytes</span><span class="p">.</span>
<span class="err">}</span>

<span class="n">func</span> <span class="n">MakeX</span><span class="p">()</span> <span class="o">*</span><span class="n">X</span> <span class="err">{</span>
    <span class="n">x</span> <span class="p">:</span><span class="o">=</span> <span class="o">&amp;</span><span class="n">X</span><span class="err">{}</span>
    <span class="o">//</span> <span class="n">Preinitialize</span> <span class="n">buf</span> <span class="k">with</span> <span class="n">the</span> <span class="n">backing</span> <span class="nb">array</span><span class="p">.</span>
    <span class="n">x</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">bufArray</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span>
<span class="err">}</span>
</code></pre></div>


</li>
<li>
<p>If possible use smaller data types. For example, use <code>int8</code> instead of
    <code>int</code>.</p>
</li>
<li>
<p>Objects that do not contain any pointers (note that strings, slices, maps
    and chans contain implicit pointers), are not scanned by garbage collector.
    For example, a 1GB byte slice virtually does not affect garbage collection
    time. So if you remove pointers from actively used objects, it can
    positively impact garbage collection time. Some possibilities are: replace
    pointers with indices, split object into two parts one of which does not
    contain pointers.</p>
</li>
<li>
<p>Use freelists to reuse transient objects and reduce number of allocations.
    Standard library contains <a href="http://tip.golang.org/pkg/sync/#Pool">sync.Pool</a>
    type that allows to reuse the same object several times in between garbage
    collections. However, be aware that, as any manual memory management scheme,
    incorrect use of sync.Pool can lead to use-after-free bugs.</p>
</li>
</ol>
<p>You can also use the Garbage Collector Trace (see below) to get some insights
into memory issues.</p>
<p>TODO(dvyukov): mention that stats are updated in a deferred way: "Memprof stats
are updated in a deferred way. This is required in order to present a consistent
picture in the situation when allocs are coming continuously and frees are
coming in batches afterwards. Several consecutive GCs push the update pipeline
forward. That's what you observe. So if you profile a live server then any
sample will give you a consistent snapshot. However, if the program completes
some activity and you want to collect the snapshot after this activity, then you
need to execute 2 or 3 GCs before the collection."</p>
<h2 id="blocking-profiler">Blocking Profiler</h2>
<p>The blocking profiler shows where goroutine block waiting on synchronization
primitives (including timer channels). You can collect it in similar ways as CPU
profile: with <code>go test --blockprofile</code>
(<a href="http://golang.org/cmd/go/#hdr-Description_of_testing_flags">http://golang.org/cmd/go/#hdr-Description_of_testing_flags</a>), with
<a href="http://golang.org/pkg/net/http/pprof">net/http/pprof</a> via
<a href="http://myserver:6060:/debug/pprof/block">http://myserver:6060:/debug/pprof/block</a> or by calling
<a href="http://golang.org/pkg/runtime/pprof/#Profile.WriteTo">runtime/pprof.Lookup("block").WriteTo</a>.</p>
<p>But there is significant caveat -- the blocking profiler is not enabled by
default. <code>go test --blockprofile</code> will enable it for you automatically. However,
if you use <code>net/http/pprof</code> or <code>runtime/pprof</code>, you need to enable it manually
(otherwise the profile will be empty). To enable the blocking profiler call
<a href="http://golang.org/pkg/runtime/#SetBlockProfileRate">runtime.SetBlockProfileRate</a>.
SetBlockProfileRate controls the fraction of goroutine blocking events that are
reported in the blocking profile. The profiler aims to sample an average of one
blocking event per the specified amount of nanoseconds spent blocked. To include
every blocking event in the profile, set the rate to 1.</p>
<p>If a function contains several blocking operations and it's not obvious which
one leads to blocking, use <code>--lines</code> flag to pprof.</p>
<p>Note that not all blocking is bad. When a goroutine blocks, the underlying
worker thread simply switches to another goroutine. So blocking in the
cooperative Go environment is very different from blocking on a mutex in a
non-cooperative systems (e.g. typical C++ or Java threading libraries, where
blocking leads to thread idling and expensive thread context switches). To give
you some feeling, let's consider some examples.</p>
<p>Blocking on a time.Ticker is usually OK. If a goroutine blocks on a Ticker for
10 seconds, you will see 10 seconds of blocking in the profile, which is
perfectly fine. Blocking on <code>sync.WaitGroup</code> is frequently OK. For example, is a
task takes 10 seconds, the goroutine waiting on a WaitGroup for completion will
account for 10 seconds of blocking in the profile. Blocking on sync.Cond may or
may not be OK, depending on the situation. Consumer blocking on a channel
suggests slow producers or lack of work. Producer blocking on a channel suggests
that consumers are slower, but this is frequently OK. Blocking on a
channel-based semaphore shows how much goroutines are gated on the semaphore.
Blocking on a sync.Mutex or sync.RWMutex is usually bad. You can use <code>--ignore</code>
flag to pprof to exclude known uninteresting blocking from a profile during
visualization.</p>
<p>Blocking of goroutines can lead to two negative consequences:</p>
<ol>
<li>
<p>Program does not scale with processors due to lack of work. Scheduler Trace
    can help to identify this case.</p>
</li>
<li>
<p>Excessive goroutine blocking/unblocking consumes CPU time. CPU Profiler can
    help to identify this case (look at the System component).</p>
</li>
</ol>
<p>Here are some common suggestions that can help to reduce goroutine blocking:</p>
<ol>
<li>
<p>Use sufficiently buffered channels in producer-consumer scenarios.
    Unbuffered channels substantially limit available parallelism in the
    program.</p>
</li>
<li>
<p>Use <code>sync.RWMutex</code> instead of <code>sync.Mutex</code> for read-mostly workloads.
    Readers never block other readers in <code>sync.RWMutex</code>, even on implementation
    level.</p>
</li>
<li>
<p>In some cases it's possible to remove mutexes entirely by using
    copy-on-write technique. If the protected data structure is modified
    infrequently and it's feasible to make copies of it, then it can be updated
    as follows:</p>
<div class="codehilite"><pre><span></span><code><span class="n">type</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Routes</span><span class="w">   </span><span class="k">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="n">net</span><span class="p">.</span><span class="n">Addr</span><span class="w"></span>
<span class="w">    </span><span class="n">Backends</span><span class="w"> </span><span class="err">[]</span><span class="n">net</span><span class="p">.</span><span class="n">Addr</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="nf">var</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="k">atomic</span><span class="p">.</span><span class="k">Value</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">*</span><span class="n">Config</span><span class="w"></span>

<span class="o">//</span><span class="w"> </span><span class="n">Worker</span><span class="w"> </span><span class="n">goroutines</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">obtain</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="w"></span>
<span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="n">UpdateConfig</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="k">called</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="n">least</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="k">before</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="w"></span>
<span class="n">func</span><span class="w"> </span><span class="n">CurrentConfig</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="n">Config</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="k">Load</span><span class="p">().(</span><span class="o">*</span><span class="n">Config</span><span class="p">)</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="o">//</span><span class="w"> </span><span class="n">Background</span><span class="w"> </span><span class="n">goroutine</span><span class="w"> </span><span class="n">periodically</span><span class="w"> </span><span class="n">creates</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Config</span><span class="w"> </span><span class="k">object</span><span class="w"></span>
<span class="o">//</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">sets</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">function</span><span class="p">.</span><span class="w"></span>
<span class="n">func</span><span class="w"> </span><span class="n">UpdateConfig</span><span class="p">(</span><span class="n">cfg</span><span class="w"> </span><span class="o">*</span><span class="n">Config</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="n">config</span><span class="p">.</span><span class="n">Store</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
</code></pre></div>


<p>This pattern prevents the writer from blocking readers during update.</p>
</li>
<li>
<p>Partitioning is another general technique for reducing contention/blocking
    on shared mutable data structures. Below is an example of how to partition a
    hashmap:</p>
<div class="codehilite"><pre><span></span><code><span class="n">type</span><span class="w"> </span><span class="k">Partition</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sync</span><span class="p">.</span><span class="n">RWMutex</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="k">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="n">string</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">const</span><span class="w"> </span><span class="n">partCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="w"></span>
<span class="nf">var</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">[</span><span class="n">partCount</span><span class="o">]</span><span class="k">Partition</span><span class="w"></span>

<span class="n">func</span><span class="w"> </span><span class="n">Find</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="n">idx</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">partCount</span><span class="w"></span>
<span class="w">    </span><span class="n">part</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span><span class="w"></span>
<span class="w">    </span><span class="n">part</span><span class="p">.</span><span class="n">RLock</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="err">:</span><span class="o">=</span><span class="w"> </span><span class="n">part</span><span class="p">.</span><span class="n">m</span><span class="o">[</span><span class="n">k</span><span class="o">]</span><span class="w"></span>
<span class="w">    </span><span class="n">part</span><span class="p">.</span><span class="n">RUnlock</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
</code></pre></div>


</li>
<li>
<p>Local caching and batching of updates can help to reduce contention on
    un-partitionable data structures. Below you can see how to batch sends to a
    channel:</p>
<div class="codehilite"><pre><span></span><code><span class="n">const</span><span class="w"> </span><span class="n">CacheSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>

<span class="n">type</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="n">buf</span><span class="w"> </span><span class="o">[</span><span class="n">CacheSize</span><span class="o">]</span><span class="nc">int</span><span class="w"></span>
<span class="w">    </span><span class="n">pos</span><span class="w"> </span><span class="nc">int</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">func</span><span class="w"> </span><span class="n">Send</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="n">chan</span><span class="w"> </span><span class="o">[</span><span class="n">CacheSize</span><span class="o">]</span><span class="nc">int</span><span class="p">,</span><span class="w"> </span><span class="n">cache</span><span class="w"> </span><span class="o">*</span><span class="n">Cache</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="w"> </span><span class="nc">int</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="n">cache</span><span class="p">.</span><span class="n">buf</span><span class="o">[</span><span class="n">cache.pos</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">value</span><span class="w"></span>
<span class="w">    </span><span class="n">cache</span><span class="p">.</span><span class="n">pos</span><span class="o">++</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">pos</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CacheSize</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">buf</span><span class="w"></span>
<span class="w">        </span><span class="n">cache</span><span class="p">.</span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="err">}</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
</code></pre></div>


<p>This technique is not limited to channels. It can be used to batch updates
to a map, batch allocations, etc.</p>
</li>
<li>
<p>Use <a href="http://tip.golang.org/pkg/sync/#Pool">sync.Pool</a> for freelists instead
    of chan-based or mutex-protected freelists. sync.Pool uses smart techniques
    internally to reduce blocking.</p>
</li>
</ol>
<h2 id="goroutine-profiler">Goroutine Profiler</h2>
<p>The goroutine profiler simply gives you current stacks of all live goroutines in
the process. It can be handy to debug load balancing issues (see Scheduler Trace
section below), or to debug deadlocks. The profile makes sense only for a
running app, so go test does not expose it. You can collect the profile with
<a href="http://golang.org/pkg/net/http/pprof">net/http/pprof</a> via
<a href="http://myserver:6060:/debug/pprof/goroutine">http://myserver:6060:/debug/pprof/goroutine</a>, and visualize it to svg/pdf or by
calling
<a href="http://golang.org/pkg/runtime/pprof/#Profile.WriteTo">runtime/pprof.Lookup("goroutine").WriteTo</a>.
But the most useful way is to type
<a href="http://myserver:6060:/debug/pprof/goroutine?debug=2">http://myserver:6060:/debug/pprof/goroutine?debug=2</a> in your browser, which will
give you symbolized stacks similar to what you see when a program crashes. Note
that goroutines in "syscall" state consume an OS thread, other goroutines do not
(except for goroutines that called runtime.LockOSThread, which is,
unfortunately, not visible in the profile). Note that goroutines in "IO wait"
state also do not consume threads, they are parked on non-blocking network
poller (which uses epoll/kqueue/GetQueuedCompletionStatus to unpark goroutines
later).</p>
<h2 id="garbage-collector-trace">Garbage Collector Trace</h2>
<p>Aside from the profiling tools, there is another kind of tools available --
tracers. They allow to trace garbage collections, memory allocator and goroutine
scheduler state. To enable the garbage collector (GC) trace, run the program
with <code>GODEBUG=gctrace=1</code> environment variable:</p>
<div class="codehilite"><pre><span></span><code>$ <span class="nv">GODEBUG</span><span class="o">=</span><span class="nv">gctrace</span><span class="o">=</span><span class="m">1</span> ./myserver
</code></pre></div>


<p>Then the program will print output similar to the following during execution:</p>
<div class="codehilite"><pre><span></span><code><span class="err">gc9(2): 12+1+744+8 us, 2 -&gt; 10 MB, 108615 (593983-485368) objects, 4825/3620/0 sweeps, 0(0) handoff, 6(91) steal, 16/1/0 yields</span>
<span class="err">gc10(2): 12+6769+767+3 us, 1 -&gt; 1 MB, 4222 (593983-589761) objects, 4825/0/1898 sweeps, 0(0) handoff, 6(93) steal, 16/10/2 yields</span>
<span class="err">gc11(2): 799+3+2050+3 us, 1 -&gt; 69 MB, 831819 (1484009-652190) objects, 4825/691/0 sweeps, 0(0) handoff, 5(105) steal, 16/1/0 yields</span>
</code></pre></div>


<p>Let's consider the meaning of these numbers. One line per GC is printed. The
first number ("gc9") is the number of GC (this is the 9-th GC since program
start). The number in parens ("(2)") is the number of worker threads
participated in the GC. The next 4 numbers ("12+1+744+8 us") mean
stop-the-world, sweeping, marking and waiting for worker threads to finish, in
microseconds, respectively. The next 2 numbers ("2 -&gt; 10 MB") mean size of live
heap after the previous GC and full heap size (including garbage) before the
current GC. The next 3 numbers ("108615 (593983-485368) objects") are total
number of objects in heap (including garbage) and total number of memory
allocation and free operations. The next 3 numbers ("4825/3620/0 sweeps")
characterize sweep phase (of the previous GC): there were total 4825 memory
spans, 3620 were swept on demand or in background, 0 were swept during
stop-the-world phase (the rest were unused spans). The next 4 numbers ("0(0)
handoff, 6(91) steal") characterize load balancing during parallel mark phase:
there were 0 object handoff operations (0 objects were handoff), and 6 steal
operations (91 objects were stolen). The last 3 numbers ("16/1/0 yields")
characterize effectiveness of parallel mark phase: there were total of 17 yield
operations during waiting for another thread.</p>
<p>The GC is <a href="http://www.brpreiss.com/books/opus5/html/page424.html">mark-and-sweep
type</a>. Total GC can be
expressed as:</p>
<div class="codehilite"><pre><span></span><code><span class="err">Tgc = Tseq + Tmark + Tsweep</span>
</code></pre></div>


<p>where Tseq is time to stop user goroutines and some preparation activities
(usually small); Tmark is heap marking time, marking happens when all user
goroutines are stopped, and thus can significantly affect latency of processing;
Tsweep is heap sweeping time, sweeping generally happens concurrently with
normal program execution, and so is not so critical for latency.</p>
<p>Marking time can be approximately expressed as:</p>
<div class="codehilite"><pre><span></span><code><span class="err">Tmark = C1*Nlive + C2*MEMlive_ptr + C3*Nlive_ptr</span>
</code></pre></div>


<p>where Nlive is the number of live objects in the heap during GC, <code>MEMlive_ptr</code>
is the amount of memory occupied by live objects with pointers, <code>Nlive_ptr</code> is
the number of pointers in live objects.</p>
<p>Sweeping time can be approximately expressed as:</p>
<div class="codehilite"><pre><span></span><code><span class="err">Tsweep = C4*MEMtotal + C5*MEMgarbage</span>
</code></pre></div>


<p>where <code>MEMtotal</code> is the total amount of heap memory, <code>MEMgarbage</code> is the amount
of garbage in the heap.</p>
<p>Next GC happens after the program has allocated an extra amount of memory
proportional to the amount already in use. The proportion is controlled by GOGC
environment variable (100 by default). If GOGC=100 and the program is using 4M
of heap memory, runtime will trigger GC again when the program gets to 8M. This
keeps the GC cost in linear proportion to the allocation cost. Adjusting GOGC
changes the linear constant and also the amount of extra memory used.</p>
<p>Only sweeping depends on total size of the heap, and sweeping happens
concurrently with normal program execution. So it can make sense to set GOGC to
a higher value (200, 300, 500, etc) if you can afford extra memory consumption.
For example, GOGC=300 can reduce garbage collection overhead by up to 2 times
while keeping latencies the same (at the cost of 2 times larger heap).</p>
<p>GC is parallel and generally scales well with hardware parallelism. So it can
make sense to set GOMAXPROCS to higher value even for sequential programs just
to speed up garbage collections. However, note that number of garbage collector
threads is currently bounded by 8.</p>
<h2 id="memory-allocator-trace">Memory Allocator Trace</h2>
<p>Memory allocator traces simply dumps all memory allocation and free operations
onto console. It's enabled with GODEBUG=allocfreetrace=1 environment variable.
The output looks along the lines of:</p>
<div class="codehilite"><pre><span></span><code><span class="n">tracealloc</span><span class="p">(</span><span class="mh">0xc208062500</span><span class="p">,</span><span class="w"> </span><span class="mh">0x100</span><span class="p">,</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nf">parse</span><span class="p">.</span><span class="n">Node</span><span class="p">)</span><span class="w"></span>
<span class="n">goroutine</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">[</span><span class="n">running</span><span class="o">]</span><span class="err">:</span><span class="w"></span>
<span class="n">runtime</span><span class="p">.</span><span class="n">mallocgc</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3eb7c1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">runtime</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="nl">goc</span><span class="p">:</span><span class="mi">190</span><span class="w"> </span><span class="o">+</span><span class="mh">0x145</span><span class="w"> </span><span class="n">fp</span><span class="o">=</span><span class="mh">0xc2080b39f8</span><span class="w"></span>
<span class="n">runtime</span><span class="p">.</span><span class="n">growslice</span><span class="p">(</span><span class="mh">0x31f840</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc208060700</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">runtime</span><span class="o">/</span><span class="n">slice</span><span class="p">.</span><span class="nl">goc</span><span class="p">:</span><span class="mi">76</span><span class="w"> </span><span class="o">+</span><span class="mh">0xbb</span><span class="w"> </span><span class="n">fp</span><span class="o">=</span><span class="mh">0xc2080b3a90</span><span class="w"></span>
<span class="nc">text</span><span class="o">/</span><span class="n">template</span><span class="o">/</span><span class="nf">parse</span><span class="p">.(</span><span class="o">*</span><span class="n">Tree</span><span class="p">).</span><span class="nf">parse</span><span class="p">(</span><span class="mh">0xc2080820e0</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc208023620</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nc">text</span><span class="o">/</span><span class="n">template</span><span class="o">/</span><span class="nf">parse</span><span class="o">/</span><span class="nf">parse</span><span class="p">.</span><span class="k">go</span><span class="err">:</span><span class="mi">289</span><span class="w"> </span><span class="o">+</span><span class="mh">0x549</span><span class="w"> </span><span class="n">fp</span><span class="o">=</span><span class="mh">0xc2080b3c50</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>

<span class="n">tracefree</span><span class="p">(</span><span class="mh">0xc208002d80</span><span class="p">,</span><span class="w"> </span><span class="mh">0x120</span><span class="p">)</span><span class="w"></span>
<span class="n">goroutine</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">[</span><span class="n">running</span><span class="o">]</span><span class="err">:</span><span class="w"></span>
<span class="n">runtime</span><span class="p">.</span><span class="n">MSpan_Sweep</span><span class="p">(</span><span class="mh">0x73b080</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">runtime</span><span class="o">/</span><span class="n">mgc0</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">1880</span><span class="w"> </span><span class="o">+</span><span class="mh">0x514</span><span class="w"> </span><span class="n">fp</span><span class="o">=</span><span class="mh">0xc20804b8f0</span><span class="w"></span>
<span class="n">runtime</span><span class="p">.</span><span class="n">MCentral_CacheSpan</span><span class="p">(</span><span class="mh">0x69c858</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">runtime</span><span class="o">/</span><span class="n">mcentral</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">48</span><span class="w"> </span><span class="o">+</span><span class="mh">0x2b5</span><span class="w"> </span><span class="n">fp</span><span class="o">=</span><span class="mh">0xc20804b920</span><span class="w"></span>
<span class="n">runtime</span><span class="p">.</span><span class="n">MCache_Refill</span><span class="p">(</span><span class="mh">0x737000</span><span class="p">,</span><span class="w"> </span><span class="mh">0xc200000012</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">runtime</span><span class="o">/</span><span class="n">mcache</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">78</span><span class="w"> </span><span class="o">+</span><span class="mh">0x119</span><span class="w"> </span><span class="n">fp</span><span class="o">=</span><span class="mh">0xc20804b950</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</code></pre></div>


<p>The trace contains address of the memory block, size, type, goroutine id and the
stack trace. It's probably more useful for debugging, but can give very
fine-grained info for allocation optimizations as well.</p>
<h2 id="scheduler-trace">Scheduler Trace</h2>
<p>Scheduler trace can provide insights into dynamic behavior of the goroutine
scheduler and allow to debug load balancing and scalability issues. To enable
the scheduler trace trace, run the program with GODEBUG=schedtrace=1000
environment variable (the value means period of output, in ms, in this case it's
once per second):</p>
<div class="codehilite"><pre><span></span><code>$ <span class="nv">GODEBUG</span><span class="o">=</span><span class="nv">schedtrace</span><span class="o">=</span><span class="m">1000</span> ./myserver
</code></pre></div>


<p>Then the program will print output similar to the following during execution:</p>
<div class="codehilite"><pre><span></span><code><span class="err">SCHED 1004ms: gomaxprocs=4 idleprocs=0 threads=11 idlethreads=4 runqueue=8 [0 1 0 3]</span>
<span class="err">SCHED 2005ms: gomaxprocs=4 idleprocs=0 threads=11 idlethreads=5 runqueue=6 [1 5 4 0]</span>
<span class="err">SCHED 3008ms: gomaxprocs=4 idleprocs=0 threads=11 idlethreads=4 runqueue=10 [2 2 2 1]</span>
</code></pre></div>


<p>The first number ("1004ms") is time since program start. Gomaxprocs is the
current value of GOMAXPROCS. Idleprocs is the number of idling processors (the
rest are executing Go code). Threads is the total number of worker threads
created by the scheduler (threads can be in 3 states: execute Go code
(gomaxprocs-idleprocs), execute syscalls/cgocalls or idle). Idlethreads is the
number of idling worker threads. Runqueue is the length of global queue with
runnable goroutines. The numbers in square brackets ("[0 1 0 3]") are lengths of
per-processor queues with runnable goroutines. Sum of lengths of global and
local queues represents the total number of goroutines available for execution.</p>
<p>Note: You can combine any of the tracers as
GODEBUG=gctrace=1,allocfreetrace=1,schedtrace=1000.</p>
<p>Note: There is also detailed scheduler trace, which you can enable with
GODEBUG=schedtrace=1000,scheddetail=1. It prints detailed info about every
goroutine, worker thread and processor. We won't describe its format here as
it's mainly useful for scheduler developers; but you can find details in
<a href="https://code.google.com/p/go/source/browse/src/pkg/runtime/proc.c">src/pkg/runtime/proc.c</a>.</p>
<p>The scheduler trace is useful when a program does not scale linearly with
GOMAXPROCS and/or does not consume 100% of CPU time. The ideal situation is when
all processors are busy executing Go code, number of threads is reasonable,
there is plenty of work in all queues and the work is reasonably evenly
distributed:</p>
<div class="codehilite"><pre><span></span><code><span class="err">gomaxprocs=8 idleprocs=0 threads=40 idlethreads=5 runqueue=10 [20 20 20 20 20 20 20 20]</span>
</code></pre></div>


<p>A bad situation is when something of the above does not hold. For example the
following sample demonstrates shortage of work to keep all processors busy:</p>
<div class="codehilite"><pre><span></span><code><span class="err">gomaxprocs=8 idleprocs=6 threads=40 idlethreads=30 runqueue=0 [0 2 0 0 0 1 0 0]</span>
</code></pre></div>


<p>Note: use OS-provided means to measure actual CPU utilization as the ultimate
characteristic. On Unix family of operating system it is top command; on Windows
it is Task Manager.</p>
<p>You can use the goroutine profiler to understand where goroutines block in the
case of work shortage. Note that load imbalance is not ultimately bad as long as
all processors are busy, it will just cause some moderate load balancing
overheads.</p>
<h2 id="memory-statistics">Memory Statistics</h2>
<p>Go runtime exposes coarse-grained memory statistics via
<a href="http://golang.org/pkg/runtime/#ReadMemStats">runtime.ReadMemStats</a> function.
The statistics are also exposed via net/http/pprof at the bottom of
<a href="http://myserver:6060/debug/pprof/heap?debug=1">http://myserver:6060/debug/pprof/heap?debug=1</a>. The statistics are described
<a href="http://golang.org/pkg/runtime/#MemStats">here</a>. Some of the interesting fields
are:</p>
<ol>
<li>HeapAlloc - current heap size.</li>
<li>HeapSys - total heap size.</li>
<li>HeapObjects - total number of objects in the heap.</li>
<li>HeapReleased - amount of memory released to the OS; runtime releases to the
    OS memory unused for 5 minutes, you can force this process with
    runtime/debug.FreeOSMemory.</li>
<li>Sys - total amount of memory allocated from OS.</li>
<li>Sys-HeapReleased - effective memory consumption of the program.</li>
<li>StackSys - memory consumed for goroutine stacks (note that some stacks are
    allocated from heap and are not accounted here, unfortunately there is no
    way to get total size of stacks
    (<a href="https://code.google.com/p/go/issues/detail?id=7468">https://code.google.com/p/go/issues/detail?id=7468</a>)).</li>
<li>MSpanSys/MCacheSys/BuckHashSys/GCSys/OtherSys - amount of memory allocated
    by runtime for various auxiliary purposes; they are generally not
    interesting, unless they are too high.</li>
<li>PauseNs - durations of last garbage collections.</li>
</ol>
<h2 id="heap-dumper">Heap Dumper</h2>
<p>The last available tool is heap dumper, it can write state of the whole heap
into a file for future exploration. It can be useful for identifying memory
leaks and getting insights into program memory consumption.</p>
<p>First, you need to write the dump using
<a href="http://tip.golang.org/pkg/runtime/debug/#WriteHeapDump">runtime/debug.WriteHeapDump</a>
function:</p>
<div class="codehilite"><pre><span></span><code><span class="err">    f, err := os.Create(&quot;heapdump&quot;)</span>
<span class="err">    if err != nil { ... }</span>
<span class="err">    debug.WriteHeapDump(f.Fd())</span>
</code></pre></div>


<p>Then you can either render it to a dot file with graphical representation of the
heap or convert it to hprof format. To render it to a dot file:</p>
<div class="codehilite"><pre><span></span><code>$ go get github.com/randall77/hprof/dumptodot
$ dumptodot heapdump mybinary &gt; heap.dot
</code></pre></div>


<p>and open <code>heap.dot</code> with Graphviz.</p>
<p>To convert it to <code>hprof</code> format:</p>
<div class="codehilite"><pre><span></span><code>$ go get github.com/randall77/hprof/dumptohprof
$ dumptohprof heapdump heap.hprof
$ jhat heap.hprof
</code></pre></div>


<p>and navigate your browser to <a href="http://myserver:7000">http://myserver:7000</a>.</p>
<h2 id="concluding-remarks">Concluding Remarks</h2>
<p>Optimization is an open problem, there are simple recipes that you can use to
improve performance. Sometimes optimization requires complete re-architecture of
the program. But we hope that the tools will be a valuable addition to your
toolbox, that you can use to at least analyze and understand what happens.
<a href="http://blog.golang.org/profiling-go-programs">Profiling Go Programs</a> is a good
tutorial on usage of CPU and memory profilers to optimize a simple program.</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: September 21, 2018
    
  </small>
</div>
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../PerfDashboard/" title="PerfDashboard" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                PerfDashboard
              </div>
            </div>
          </a>
        
        
          <a href="../Plan9/" title="Plan9" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Plan9
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c51dfa35.min.js"></script>
      <script src="../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.0.5/es5/startup.js"></script>
      
    
  </body>
</html>